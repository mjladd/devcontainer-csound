{"instruction": "Write a CSound instrument that demonstrates pitch detection opcodes: pitch, ptrack, pvspitch", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\ninstr 1\n    ; pitch opcode: koct, kamp pitch asig, iupdte, ilo, ihi, idbthresh [, ifrqs] [, iconf]\n    ; Time-domain pitch tracker\n    ; iupdte - analysis update rate (seconds)\n    ; ilo, ihi - pitch range (Hz)\n    ; idbthresh - amplitude threshold (dB)\n    ; Returns koct (octave format) and kamp (amplitude)\n    \n    ; Generate a signal with varying pitch\n    kFreq linseg 220, p3*0.5, 440, p3*0.5, 330\n    aIn oscili 0.3, kFreq, -1\n    \n    ; Detect pitch\n    koct, kamp pitch aIn, 0.01, 100, 1000, -60\n    \n    ; Convert octave to Hz\n    kDetectedHz = cpsoct(koct)\n    \n    ; Create a sine following the detected pitch\n    aFollow oscili kamp*0.5, kDetectedHz, -1\n    \n    outs aIn, aFollow\nendin\n\ninstr 2\n    ; ptrack opcode: kfreq, kamp ptrack asig, ihopsize [, ipeaks]\n    ; FFT-based pitch tracker\n    ; ihopsize - hop size (power of 2)\n    ; ipeaks - number of spectral peaks to analyze\n    \n    ; Input with vibrato\n    kVib oscili 8, 5, -1\n    aIn oscili 0.3, 330+kVib, -1\n    \n    ; Track pitch\n    kFreq, kAmp ptrack aIn, 512\n    \n    ; Generate harmonics based on detected pitch\n    aHarm1 oscili kAmp*0.3, kFreq, -1\n    aHarm2 oscili kAmp*0.2, kFreq*2, -1\n    aHarm3 oscili kAmp*0.1, kFreq*3, -1\n    \n    aOut = aHarm1 + aHarm2 + aHarm3\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\ninstr 3\n    ; pvspitch opcode: kfreq, kamp pvspitch fsig, ithresh\n    ; Phase vocoder-based pitch tracking\n    ; ithresh - amplitude threshold\n    \n    ; Complex input signal\n    aOsc1 oscili 0.15, 220, -1\n    aOsc2 oscili 0.15, 330, -1\n    aIn = aOsc1 + aOsc2\n    \n    ; Analyze\n    fsig pvsanal aIn, 1024, 256, 1024, 1\n    \n    ; Track pitch\n    kFreq, kAmp pvspitch fsig, 0.01\n    \n    ; Use detected pitch to control a filter\n    aFilt butterbp aIn, kFreq*2, kFreq*0.5\n    \n    outs aIn*0.5, aFilt*0.8\nendin\n\ninstr 4\n    ; Pitch-to-MIDI conversion example\n    kMidiNote linseg 60, p3*0.3, 72, p3*0.4, 67, p3*0.3, 60\n    kFreq = cpsmidinn(kMidiNote)\n    aIn oscili 0.3, kFreq, -1\n    \n    ; Detect and quantize to nearest semitone\n    koct, kamp pitch aIn, 0.01, 100, 1000, -60\n    kHz = cpsoct(koct)\n    kMidiDetected = round(ftom(kHz))\n    kQuantized = cpsmidinn(kMidiDetected)\n    \n    ; Generate quantized version\n    aQuantized oscili kamp*0.5, kQuantized, -1\n    \n    outs aIn*0.5, aQuantized*0.5\nendin\n\ninstr 5\n    ; Pitch tracking with confidence\n    aIn vco2 0.3, 165, 0\n    aIn += rand(0.05)  ; Add noise\n    \n    ; Track with pitch opcode\n    koct, kamp pitch aIn, 0.01, 80, 800, -50, 16, 7\n    kFreq = cpsoct(koct)\n    \n    ; Only use detection when amplitude is strong\n    kGate = (kamp > 0.1 ? 1 : 0)\n    kFreqFiltered = (kGate == 1 ? kFreq : 165)\n    \n    ; Generate clean version\n    aClean oscili kamp*0.6, kFreqFiltered, -1\n    \n    outs aIn*0.5, aClean*0.5\nendin\n\n</CsInstruments>\n<CsScore>\n\ni1 0 3\ni2 4 3\ni3 8 3\ni4 12 3\ni5 16 3\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
