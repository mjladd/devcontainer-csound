{"instruction": "Write a CSound instrument that demonstrates signal measurement opcodes: max_k, min_k, rms, peak, vactrol", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\ninstr 1\n    ; max_k opcode: kmax max_k ksig1, ksig2 [, ksig3, ...]\n    ; Find maximum of k-rate signals\n    \n    ; Three oscillating values\n    kSig1 lfo 0.5, 0.5, 0\n    kSig2 lfo 0.3, 0.7, 0\n    kSig3 lfo 0.4, 0.3, 0\n    \n    ; Find maximum\n    kMax max_k kSig1, kSig2, kSig3\n    \n    ; Use max to control amplitude\n    aOsc oscili kMax+0.5, 440, -1\n    \n    outs aOsc*0.5, aOsc*0.5\nendin\n\ninstr 2\n    ; min_k opcode: kmin min_k ksig1, ksig2 [, ksig3, ...]\n    ; Find minimum of k-rate signals\n    \n    kSig1 linseg 0.2, p3*0.5, 0.8, p3*0.5, 0.4\n    kSig2 linseg 0.6, p3*0.5, 0.3, p3*0.5, 0.7\n    kSig3 = 0.5\n    \n    ; Find minimum\n    kMin min_k kSig1, kSig2, kSig3\n    \n    ; Use min for frequency control\n    aOsc vco2 0.3, 200 + kMin*500, 10\n    \n    outs aOsc, aOsc\nendin\n\ninstr 3\n    ; rms opcode: kres rms asig [, ihp] [, iskip]\n    ; Root mean square amplitude measurement\n    ; ihp - high-pass filter frequency\n    \n    aIn buzz 0.5, 220, 20, -1\n    aIn *= linseg(0.2, p3*0.5, 1, p3*0.5, 0.3)\n    \n    ; Measure RMS\n    kRMS rms aIn\n    \n    ; Use RMS to control another parameter\n    kCf = 500 + kRMS*2000\n    aFilt butterlp aIn, kCf\n    \n    outs aIn*0.5, aFilt*0.5\nendin\n\ninstr 4\n    ; peak opcode: kres peak asig [, iprd]\n    ; Track peak amplitude\n    ; iprd - period for peak detection\n    \n    aIn vco2 0.6, 330, 0\n    aIn *= linseg(0.1, 0.1, 1, 0.2, 0.3, p3-0.3, 0.5)\n    \n    ; Track peak\n    kPeak peak aIn\n    \n    ; Normalize based on peak\n    kGain = (kPeak > 0.1 ? 0.5/kPeak : 1)\n    aOut = aIn * kGain\n    \n    outs aIn*0.4, aOut*0.6\nendin\n\ninstr 5\n    ; vactrol opcode: ares vactrol asig, kattack, krelease [, ilevel]\n    ; Optical compressor envelope follower\n    ; kattack - attack time (seconds)\n    ; krelease - release time (seconds)\n    \n    aIn buzz 0.5, 165, 25, -1\n    aIn *= expseg(1, 0.05, 0.3, 0.1, 1, 0.15, 0.4, p3-0.3, 0.2)\n    \n    ; Vactrol envelope following\n    kAtt = 0.01\n    kRel = 0.2\n    aEnv vactrol aIn, kAtt, kRel\n    \n    ; Use envelope to control filter\n    kCf = 300 + aEnv*2500\n    aFilt butterbp aIn, kCf, kCf*0.5\n    \n    outs aIn*0.4, aFilt*0.6\nendin\n\ninstr 6\n    ; Combined measurements for dynamics control\n    aIn vco2 0.5, 220, 10\n    aIn *= linseg(0.3, 0.2, 1, 0.5, 0.2, p3-0.7, 0.6)\n    \n    ; Measure RMS and peak\n    kRMS rms aIn\n    kPeak peak aIn\n    \n    ; Calculate crest factor (peak/RMS ratio)\n    kCrest = (kRMS > 0.01 ? kPeak/kRMS : 1)\n    \n    ; Use crest factor for dynamics\n    kComp = (kCrest > 2 ? 2/kCrest : 1)\n    aOut = aIn * kComp\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\n</CsInstruments>\n<CsScore>\n\ni1 0 3\ni2 4 3\ni3 8 3\ni4 12 3\ni5 16 3\ni6 20 4\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
