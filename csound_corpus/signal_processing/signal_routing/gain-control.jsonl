{"instruction": "Write a CSound instrument that demonstrates gain control opcodes: gain, amp, rms, balance", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\ninstr 1\n    ; gain opcode: ares gain asig, kgain [, iskip]\n    ; Apply k-rate gain with smoothing\n    ; kgain - gain multiplier\n    ; iskip - skip initialization\n    \n    aOsc oscili 0.5, 440, -1\n    \n    ; Time-varying gain\n    kGain linseg 0.1, p3*0.3, 1, p3*0.4, 0.5, p3*0.3, 0.2\n    \n    aOut gain aOsc, kGain\n    \n    outs aOut, aOut\nendin\n\ninstr 2\n    ; amp opcode: iamp amp iscale\n    ; Convert dB to amplitude\n    \n    ; Gain in dB\n    iGainDB = -6\n    iAmp amp iGainDB\n    \n    aOsc oscili iAmp, 330, -1\n    \n    outs aOsc, aOsc\nendin\n\ninstr 3\n    ; Manual gain control with dB conversion\n    aIn vco2 0.5, 220, 0\n    \n    ; Gain in dB, converted to linear\n    kGainDB linseg -20, p3*0.5, 0, p3*0.5, -12\n    kGain = ampdb(kGainDB)\n    \n    aOut = aIn * kGain\n    \n    outs aOut, aOut\nendin\n\ninstr 4\n    ; RMS-based automatic gain control\n    aIn buzz 0.5, 165, 20, -1\n    aIn *= linseg(0.3, p3*0.25, 1, p3*0.5, 0.5, p3*0.25, 0.8)\n    \n    ; Measure RMS level\n    kRMS rms aIn\n    \n    ; Target RMS level\n    kTarget = 0.3\n    \n    ; Calculate correction gain\n    kGain = (kRMS > 0.01 ? kTarget/kRMS : 1)\n    \n    ; Limit gain range\n    kGain limit kGain, 0.1, 3\n    \n    ; Apply with smoothing\n    kGainSmooth port kGain, 0.1\n    \n    aOut = aIn * kGainSmooth\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\ninstr 5\n    ; balance opcode for consistent loudness\n    ; ares balance asig, acomp [, ihp] [, iskip]\n    \n    ; Variable amplitude source\n    aSource vco2 0.5, 220, 10\n    aSource *= linseg(0.2, p3*0.33, 1, p3*0.33, 0.4, p3*0.34, 0.7)\n    \n    ; Reference signal with constant amplitude\n    aRef oscili 0.3, 220, -1\n    \n    ; Balance to reference level\n    aBalanced balance aSource, aRef\n    \n    outs aSource*0.5, aBalanced*0.5\nendin\n\ninstr 6\n    ; Peak limiter\n    aIn buzz 0.8, 110, 30, -1\n    \n    ; Set ceiling\n    kCeiling = 0.5\n    \n    ; Measure peak\n    kPeak peak aIn\n    \n    ; Calculate gain reduction\n    kGain = (kPeak > kCeiling ? kCeiling/kPeak : 1)\n    \n    ; Smooth gain changes\n    kGainSmooth port kGain, 0.01\n    \n    aOut = aIn * kGainSmooth\n    \n    outs aIn*0.3, aOut*0.6\nendin\n\ninstr 7\n    ; Multi-band gain control\n    aIn vco2 0.5, 165, 0\n    \n    ; Split into bands\n    aLow butterlp aIn, 300\n    aMid butterbp aIn, 1000, 800\n    aHigh butterhp aIn, 2500\n    \n    ; Independent gain for each band\n    kGainLow = 0.8\n    kGainMid linseg 0.5, p3*0.5, 1.2, p3*0.5, 0.7\n    kGainHigh = 1.5\n    \n    ; Apply gains\n    aLow *= kGainLow\n    aMid *= kGainMid\n    aHigh *= kGainHigh\n    \n    ; Recombine\n    aMix = (aLow + aMid + aHigh) * 0.4\n    \n    outs aMix, aMix\nendin\n\n</CsInstruments>\n<CsScore>\n\ni1 0 2\ni2 3 2\ni3 6 3\ni4 10 3\ni5 14 3\ni6 18 2\ni7 21 4\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
