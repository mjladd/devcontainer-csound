{"instruction": "Write a CSound instrument that demonstrates envelope following with the peak opcode for dynamics", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\ninstr 1\n    ; peak opcode for envelope following: kmax peak asig\n    ; Tracks the peak amplitude of a signal\n    ; asig - input signal to analyze\n    ; Returns maximum absolute value\n    \n    kAmp madsr 0.01, 0.1, 0.7, 0.2\n    \n    ; Audio signal\n    aOsc oscili kAmp*0.3, 440, -1, 0\n    \n    ; Track envelope\n    kEnv peak aOsc\n    \n    ; Use envelope to control filter\n    kCutoff = 300 + kEnv*2000\n    aFilt butlp aOsc, kCutoff\n    \n    outs aFilt, aFilt\nendin\n\ninstr 2\n    ; Envelope follower for side-chain effect\n    ; Input source\n    kAmp1 madsr 0.015, 0.08, 0.65, 0.25\n    aSrc oscili kAmp1*0.3, 330, -1, 0\n    \n    ; Side-chain trigger (pulse)\n    kAmp2 madsr 0.01, 0.05, 0.3, 0.1\n    aSideChain vco2 kAmp2*0.5, 2, 2, 0.5\n    \n    ; Follow side-chain envelope\n    kSCEnv peak aSideChain\n    \n    ; Duck main signal\n    kDuck = 1 - kSCEnv*0.8\n    aOut = aSrc * kDuck\n    \n    outs aOut, aOut\nendin\n\ninstr 3\n    ; Envelope-controlled synthesis\n    kAmp madsr 0.02, 0.12, 0.6, 0.3\n    \n    ; Modulator\n    aMod oscili kAmp*0.4, 220, -1, 0\n    \n    ; Track modulator envelope\n    kModEnv peak aMod\n    \n    ; Use for FM depth\n    kDepth = kModEnv * 500\n    aCarrier oscili kAmp*0.3, 440 + aMod*kDepth, -1, 0\n    \n    outs aCarrier, aCarrier\nendin\n\ninstr 4\n    ; Dynamic EQ based on envelope\n    kAmp madsr 0.01, 0.1, 0.7, 0.2\n    \n    ; Variable amplitude source\n    kMod oscili 0.3, 0.5, -1, 0\n    aOsc oscili (0.25 + kMod)*kAmp, 165, -1, 0\n    \n    ; Track envelope\n    kEnv peak aOsc\n    \n    ; Dynamic EQ: boost lows when quiet, boost highs when loud\n    kLowGain = (kEnv < 0.3 ? 2 - kEnv*3 : 1)\n    kHighGain = (kEnv > 0.2 ? 1 + kEnv : 1)\n    \n    aLow butlp aOsc, 400\n    aHigh buthp aOsc, 1500\n    aMid = aOsc - aLow - aHigh\n    \n    aMix = aLow*kLowGain + aMid + aHigh*kHighGain\n    aMix = aMix * 0.4\n    \n    outs aMix, aMix\nendin\n\n</CsInstruments>\n<CsScore>\n\ni1 0 4\ni2 4.5 5\ni3 10 4\ni4 14.5 5\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
