{"instruction": "Write a CSound instrument that demonstrates filter analysis opcodes: peak, median, mediank", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\ninstr 1\n    ; peak opcode: kmax peak asig\n    ; Maintains the output equal to the highest absolute value received\n    ; Returns the maximum absolute value\n    ; Useful for metering and envelope detection\n    \n    kAmp madsr 0.01, 0.1, 0.7, 0.2\n    \n    ; Generate test signal\n    aOsc oscili kAmp*0.3, 440, -1, 0\n    \n    ; Track peak level\n    kPeak peak aOsc\n    \n    ; Print peak value every 0.1 seconds\n    kTrig metro 10\n    if kTrig == 1 then\n        printk2 kPeak\n    endif\n    \n    outs aOsc, aOsc\nendin\n\ninstr 2\n    ; Using peak for automatic gain control\n    kAmp madsr 0.02, 0.15, 0.6, 0.3\n    \n    ; Signal with varying amplitude\n    aOsc oscili kAmp*0.5, 330, -1, 0\n    \n    ; Track peak\n    kPeak peak aOsc\n    \n    ; Normalize based on peak (with safety threshold)\n    kGain = (kPeak > 0.01 ? 0.3 / kPeak : 1)\n    kGain limit kGain, 0, 10\n    \n    aOut = aOsc * kGain\n    \n    outs aOut, aOut\nendin\n\ninstr 3\n    ; median opcode: ares median asig, isize [, imaxsize]\n    ; Calculates median value of audio signal over a window\n    ; asig - input signal\n    ; isize - window size (must be odd number)\n    ; imaxsize - maximum window size (optional)\n    ; Useful for removing impulse noise and smoothing\n    \n    kAmp madsr 0.015, 0.08, 0.65, 0.25\n    \n    ; Generate noisy signal\n    aOsc oscili kAmp*0.25, 220, -1, 0\n    aNoise noise kAmp*0.15, 0\n    aSig = aOsc + aNoise\n    \n    ; Apply median filter to smooth\n    ; Window size of 5 samples\n    aSmooth median aSig, 5\n    \n    outs aSmooth, aSmooth\nendin\n\ninstr 4\n    ; Larger median window for more smoothing\n    kAmp madsr 0.01, 0.1, 0.6, 0.2\n    \n    ; Signal with impulses\n    aOsc oscili kAmp*0.2, 165, -1, 0\n    aImpulse mpulse kAmp*0.8, 0.25\n    aSig = aOsc + aImpulse\n    \n    ; Larger window to remove impulses\n    aSmooth median aSig, 11\n    \n    outs aSmooth, aSmooth\nendin\n\ninstr 5\n    ; mediank opcode: kres mediank ksig, isize [, imaxsize]\n    ; Median filter for k-rate signals\n    ; ksig - input k-rate signal\n    ; isize - window size (must be odd)\n    ; imaxsize - maximum window size (optional)\n    \n    ; Generate noisy k-rate signal\n    kBase linseg 200, p3, 800\n    kNoise random -100, 100\n    kSig = kBase + kNoise\n    \n    ; Smooth with median filter\n    kSmooth mediank kSig, 7\n    \n    ; Use smoothed signal for frequency\n    kAmp madsr 0.01, 0.08, 0.7, 0.2\n    aOsc oscili kAmp*0.3, kSmooth, -1, 0\n    \n    outs aOsc, aOsc\nendin\n\ninstr 6\n    ; Compare raw vs median-filtered control\n    kAmp madsr 0.015, 0.1, 0.65, 0.25\n    \n    ; Noisy control signal\n    kRaw randomi 300, 1200, 8\n    \n    ; Smoothed version\n    kSmooth mediank kRaw, 9\n    \n    ; Two oscillators for comparison\n    aRaw oscili kAmp*0.15, kRaw, -1, 0\n    aSmooth oscili kAmp*0.15, kSmooth, -1, 0\n    \n    ; Raw to left, smooth to right\n    outs aRaw, aSmooth\nendin\n\n</CsInstruments>\n<CsScore>\n\n; peak - track maximum\ni1 0 3\n\n; peak - AGC\ni2 3.5 3\n\n; median - basic smoothing\ni3 7 3\n\n; median - impulse removal\ni4 10.5 3\n\n; mediank - k-rate smoothing\ni5 14 4\n\n; mediank - comparison\ni6 18.5 4\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
