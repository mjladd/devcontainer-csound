{"instruction": "Write a CSound instrument that demonstrates spectral gating and masking opcodes: pvsgain, pvstencil, pvsmaska, pvsgate", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\n; Function tables for spectral masks\ngiMask1 ftgen 0, 0, 512, 7, 1, 100, 1, 50, 0, 100, 0, 50, 0.5, 100, 0.5, 112, 0\ngiMask2 ftgen 0, 0, 512, 7, 0, 50, 0, 50, 1, 100, 1, 50, 0.3, 150, 0.3, 112, 0\n\ninstr 1\n    ; pvsgain opcode: fsig pvsgain fsigin, kgain\n    ; Simple spectral gain\n    ; kgain - overall gain factor\n    \n    aIn buzz 0.5, 220, 25, -1\n    \n    ; Analyze\n    fsig pvsanal aIn, 1024, 256, 1024, 1\n    \n    ; Variable gain\n    kGain linseg 1, p3*0.5, 0.2, p3*0.5, 1\n    fgain pvsgain fsig, kGain\n    \n    ; Synthesize\n    aOut pvsynth fgain\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\ninstr 2\n    ; pvstencil opcode: fsig pvstencil fsigin, kgain, klevel, iftable\n    ; Spectral gating using stencil (frequency-dependent gain)\n    ; kgain - overall gain\n    ; klevel - threshold level\n    ; iftable - stencil table\n    \n    aIn vco2 0.3, 330, 0\n    \n    ; Analyze\n    fsig pvsanal aIn, 1024, 256, 1024, 1\n    \n    ; Apply stencil mask\n    kGain = 1.2\n    kLevel linseg 0, p3*0.5, 0.5, p3*0.5, 0\n    fstenc pvstencil fsig, kGain, kLevel, giMask1\n    \n    ; Synthesize\n    aOut pvsynth fstenc\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\ninstr 3\n    ; pvsmaska opcode: fsig pvsmaska fsig, fmask, kdepth\n    ; Spectral masking using another signal\n    ; fmask - masking spectrum\n    ; kdepth - masking depth (0-1)\n    \n    ; Main signal\n    aMain vco2 0.3, 220, 10\n    \n    ; Masking signal (noise)\n    aMask rand 0.2\n    aMask butterlp aMask, 3000\n    \n    ; Analyze both\n    fMain pvsanal aMain, 1024, 256, 1024, 1\n    fMask pvsanal aMask, 1024, 256, 1024, 1\n    \n    ; Apply masking\n    kDepth linseg 0, p3*0.3, 0.95, p3*0.4, 0.95, p3*0.3, 0\n    fmasked pvsmaska fMain, fMask, kDepth\n    \n    ; Synthesize\n    aOut pvsynth fmasked\n    \n    outs aMain*0.4, aOut*0.6\nendin\n\ninstr 4\n    ; Spectral gate (threshold-based)\n    ; Keep only bins above threshold\n    \n    aIn buzz 0.3, 165, 30, -1\n    aIn += rand(0.05)  ; Add noise\n    \n    ; Analyze\n    fsig pvsanal aIn, 1024, 256, 1024, 1\n    \n    ; Gate with threshold\n    kThresh linseg 0, p3*0.5, 0.3, p3*0.5, 0.05\n    fgated pvstencil fsig, 1, kThresh, -1  ; -1 = sine window\n    \n    ; Synthesize\n    aOut pvsynth fgated\n    \n    outs aIn*0.4, aOut*0.6\nendin\n\ninstr 5\n    ; Dynamic spectral masking\n    ; Mask changes over time\n    \n    aIn vco2 0.3, 110, 0\n    \n    ; Create dynamic mask signal\n    kMaskFreq linseg 50, p3, 500\n    aMask oscili 0.3, kMaskFreq, -1\n    \n    ; Analyze\n    fIn pvsanal aIn, 1024, 256, 1024, 1\n    fMask pvsanal aMask, 1024, 256, 1024, 1\n    \n    ; Mask with varying depth\n    kDepth lfo 0.5, 1, 0\n    kDepth = (kDepth + 1) * 0.5  ; 0 to 1\n    fmasked pvsmaska fIn, fMask, kDepth\n    \n    ; Synthesize\n    aOut pvsynth fmasked\n    \n    outs aIn*0.4, aOut*0.6\nendin\n\ninstr 6\n    ; Multi-band spectral gating\n    ; Different gates for different frequency regions\n    \n    aIn vco2 0.3, 220, 0\n    aIn += rand(0.08)\n    \n    ; Analyze\n    fsig pvsanal aIn, 2048, 512, 2048, 1\n    \n    ; Create frequency-dependent mask\n    ; Low freqs: gate at -30dB, highs: gate at -20dB\n    fgated pvstencil fsig, 1.2, 0.1, giMask2\n    \n    ; Synthesize\n    aOut pvsynth fgated\n    \n    outs aIn*0.4, aOut*0.6\nendin\n\n</CsInstruments>\n<CsScore>\n\ni1 0 3\ni2 4 4\ni3 9 4\ni4 14 4\ni5 19 4\ni6 24 4\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
