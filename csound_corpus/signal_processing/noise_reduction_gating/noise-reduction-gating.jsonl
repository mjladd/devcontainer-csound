{"instruction": "Write a CSound instrument that demonstrates noise reduction and gating opcodes: median, mediank, compress2 as gate", "input": "", "output": "<CsoundSynthesizer>\n<CsOptions>\n-odac\n</CsOptions>\n<CsInstruments>\n\nsr = 44100\nkr = 4410\nksmps = 10\nnchnls = 2\n0dbfs = 1\n\ninstr 1\n    ; median opcode: ares median asig, ksize [, imaxsize]\n    ; Median filter for impulse noise removal\n    ; ksize - window size (must be odd)\n    \n    ; Clean signal\n    aClean oscili 0.3, 440, -1\n    \n    ; Add impulse noise\n    kTrig metro 10\n    aNoise rand 0.5\n    aNoise *= kTrig\n    \n    aNoisy = aClean + aNoise\n    \n    ; Remove impulses with median filter\n    aFiltered median aNoisy, 5\n    \n    outs aNoisy*0.5, aFiltered*0.5\nendin\n\ninstr 2\n    ; mediank opcode: kres mediank ksig, ksize [, imaxsize]\n    ; Median filter for k-rate signals\n    \n    ; Generate noisy control signal\n    kClean linseg 220, p3, 880\n    kNoise random -50, 50\n    kNoisy = kClean + kNoise\n    \n    ; Smooth with median filter\n    kSmooth mediank kNoisy, 7\n    \n    ; Use for frequency control\n    aOscNoisy oscili 0.3, kNoisy, -1\n    aOscSmooth oscili 0.3, kSmooth, -1\n    \n    outs aOscNoisy*0.5, aOscSmooth*0.5\nendin\n\ninstr 3\n    ; Noise gate using compress2\n    ; compress2 opcode: ar1 compress2 asig, actl, kthresh, kloknee, khiknee, kratio, katt, krel, ilook\n    ; With ratio < 1, acts as expander/gate\n    \n    ; Signal with varying amplitude\n    aIn vco2 0.4, 220, 0\n    aIn *= linseg(0.05, 0.5, 0.8, 1, 0.1, 0.5, 0.6, p3-2, 0.05)\n    \n    ; Add noise floor\n    aNoise rand 0.03\n    aIn = aIn + aNoise\n    \n    ; Gate parameters\n    kThresh = -30  ; Threshold in dB\n    kLoKnee = 3\n    kHiKnee = 3\n    kRatio = 0.1   ; Expansion ratio (< 1 for gate)\n    kAtt = 0.003\n    kRel = 0.05\n    iLook = 0.005\n    \n    ; Apply gate\n    aGated compress2 aIn, aIn, kThresh, kLoKnee, kHiKnee, kRatio, kAtt, kRel, iLook\n    \n    outs aIn*0.5, aGated*0.5\nendin\n\ninstr 4\n    ; Adaptive noise reduction\n    ; Estimate and subtract noise floor\n    \n    ; Main signal\n    aMain buzz 0.4, 330, 15, -1\n    aMain *= linseg(1, 0.3, 0.2, 0.5, 1, p3-0.8, 0.5)\n    \n    ; Add noise\n    aNoise rand 0.1\n    aNoisy = aMain + aNoise\n    \n    ; Measure noise level during quiet passages\n    kRMS rms aNoisy\n    kNoiseFloor = (kRMS < 0.15 ? kRMS : kNoiseFloor)\n    \n    ; Gate based on noise floor\n    kThresh = ampdb(dbamp(kNoiseFloor) + 6)\n    kGate = (kRMS > kThresh ? 1 : 0)\n    kGateSmooth port kGate, 0.01\n    \n    aOut = aNoisy * kGateSmooth\n    \n    outs aNoisy*0.5, aOut*0.5\nendin\n\ninstr 5\n    ; Spectral noise reduction using PVS\n    ; Reduce noise in frequency domain\n    \n    ; Signal with noise\n    aSignal vco2 0.3, 220, 10\n    aNoise rand 0.08\n    aIn = aSignal + aNoise\n    \n    ; Analyze\n    fsig pvsanal aIn, 1024, 256, 1024, 1\n    \n    ; Create noise profile (in practice would be learned)\n    ; Simulate with spectral gate\n    fgated pvsgain fsig, 0.8\n    \n    ; Synthesize\n    aOut pvsynth fgated\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\ninstr 6\n    ; Multi-band gating\n    ; Different gates for different frequency bands\n    \n    aIn vco2 0.4, 165, 0\n    aIn *= linseg(0.8, 0.3, 0.1, 0.4, 0.7, 0.5, 0.2, p3-1.2, 0.1)\n    \n    ; Add noise\n    aNoise rand 0.05\n    aIn = aIn + aNoise\n    \n    ; Split into bands\n    aLow butterlp aIn, 500\n    aMid butterbp aIn, 1500, 1000\n    aHigh butterhp aIn, 3000\n    \n    ; Gate each band\n    kThreshLow = -35\n    kThreshMid = -30\n    kThreshHigh = -25\n    \n    aLowGated compress2 aLow, aLow, kThreshLow, 3, 3, 0.1, 0.005, 0.05, 0.005\n    aMidGated compress2 aMid, aMid, kThreshMid, 3, 3, 0.1, 0.005, 0.05, 0.005\n    aHighGated compress2 aHigh, aHigh, kThreshHigh, 3, 3, 0.1, 0.005, 0.05, 0.005\n    \n    ; Recombine\n    aOut = aLowGated + aMidGated + aHighGated\n    \n    outs aIn*0.5, aOut*0.5\nendin\n\n</CsInstruments>\n<CsScore>\n\ni1 0 3\ni2 4 4\ni3 9 4\ni4 14 3\ni5 18 3\ni6 22 4\n\ne\n</CsScore>\n</CsoundSynthesizer>"}
